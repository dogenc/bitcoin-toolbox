<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Bitcoin Toolbox — Auto-Erkennung & HD-Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: #0b0f19;
    color: #e8eef8;
    padding: 20px;
    max-width: 1100px;
    margin: 0 auto;
  }
  h1 { font-size: 20px; margin: 0 0 12px 0; color: #f6f8ff; }
  .card {
    background: #111827;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,.6);
    box-sizing: border-box;
  }
  label { display:block; margin-bottom:6px; font-weight:700; color:#d3e4ff; }
  input, textarea, select {
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid #2b3548;
    background:#1a2234;
    color:#f4f8ff;
    font-size:14px;
    box-sizing:border-box;
  }
  input:focus, select:focus, textarea:focus {
    outline:none;
    border-color:#00adb5;
    background:#1e2b40;
  }
  .row { display:flex; gap:8px; flex-wrap:wrap; }
  .row>* { flex:1; min-width:100px; }
  button {
    padding:9px 14px;
    border-radius:8px;
    background:#00adb5;
    border:none;
    color:#061418;
    font-weight:700;
    cursor:pointer;
    transition:background .2s ease;
  }
  button:hover { background:#05c2cc; }
  table {
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    font-size:13px;
  }
  th,td {
    padding:8px;
    border-bottom:1px solid rgba(255,255,255,.08);
    text-align:left;
  }
  th { color:#9fd8ff; background:#1b2434; }
  code { color:#b4e0ff; }
  .ok { color:#8ef0ac; font-weight:700; }
  .bad { color:#ff9b9b; font-weight:700; }
  footer {
    margin-top:18px;
    font-size:12px;
    color:#7f9fb9;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:12px;
  }
  .meta { font-size:13px; color:#9fb2c9; }
  #btcSpinner {
    width:80px;
    height:80px;
    margin:40px auto 0 auto;
    background:url('https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg') center/contain no-repeat;
    animation: spin 15s linear infinite;
    filter: drop-shadow(0 0 10px #ff9900);
    opacity:0.8;
  }
  @keyframes spin { 0%{transform:rotateY(0deg);} 100%{transform:rotateY(360deg);} }
  #txlist {
    margin-top:16px;
    font-size:13px;
    background:#0e1422;
    border-radius:8px;
    padding:10px 12px;
  }
  #txlist table { width:100%; border-collapse:collapse; }
  #txlist th, #txlist td {
    border-bottom:1px solid rgba(255,255,255,.06);
    padding:6px 8px;
  }
  #txlist th { color:#9fd8ff; background:#1a2234; }
  #txlist td { color:#d8eaff; }
</style>
</head>
<body>
<header><h1>Bitcoin Toolbox — Auto-Erkennung & HD-Scanner</h1></header>

<div class="card">
  <label>Eingabe</label>
  <textarea id="input" rows="3" placeholder="Bitcoin-Adresse (bc1..., 1..., 3...), xpub oder Seed-Phrase eingeben"></textarea>

  <div class="row" style="margin-top:8px">
    <select id="derivation">
      <option value="44">BIP44 (Legacy 1...)</option>
      <option value="49">BIP49 (P2SH-SegWit 3...)</option>
      <option value="84" selected>BIP84 (Bech32 bc1q...)</option>
      <option value="86">BIP86 (Taproot bc1p...)</option>
    </select>
    <input type="number" id="startIdx" min="0" value="0" placeholder="Startindex">
    <input type="number" id="count" min="1" value="5" placeholder="Anzahl Adressen">
  </div>

  <div style="margin-top:10px">
    <button id="scanBtn">Adressen & Salden abrufen</button>
  </div>

  <div id="progress" style="margin-top:10px;color:#9fd8ff;"></div>
  <div id="result" style="margin-top:10px;overflow:auto;"></div>
  <div id="txlist"></div>
</div>

<div id="btcSpinner"></div>

<footer>
  <div><strong>Sicherheit:</strong> Keine privaten Schlüssel öffentlich teilen. Dieses Tool speichert nichts. © DGKN</div>
  <div class="meta"><span id="localTime"></span> · <span id="lastChecked">Noch keine Abfrage</span></div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bip32@3.1.0/dist/index.min.js"></script>

<script>
(async function(){
  const scanBtn=document.getElementById('scanBtn');
  const resultEl=document.getElementById('result');
  const progressEl=document.getElementById('progress');
  const lastCheckedEl=document.getElementById('lastChecked');
  const localTimeEl=document.getElementById('localTime');
  const derivSelect=document.getElementById('derivation');
  const inputEl=document.getElementById('input');
  const txListEl=document.getElementById('txlist');

  function updateClock(){ localTimeEl.textContent=new Date().toLocaleString(); }
  setInterval(updateClock,1000); updateClock();

  inputEl.addEventListener('input',()=>{
    const v=inputEl.value.trim();
    if(v.startsWith('1')) derivSelect.value='44';
    else if(v.startsWith('3')) derivSelect.value='49';
    else if(v.startsWith('bc1q')) derivSelect.value='84';
    else if(v.startsWith('bc1p')) derivSelect.value='86';
  });

  async function fetchBalance(address){
    const r=await fetch(`https://blockstream.info/api/address/${address}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }

  async function fetchTxs(address){
    const r=await fetch(`https://blockstream.info/api/address/${address}/txs`);
    if(!r.ok) return [];
    return await r.json();
  }

  function satsToBtc(s){ return (Number(s)/1e8).toFixed(8); }

  function looksLikeAddress(str){
    return /^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(str)||/^bc1[ac-hj-np-z02-9]{6,87}$/i.test(str);
  }
  function looksLikeXpub(str){ return /^xpub|^ypub|^zpub/i.test(str.trim()); }

  async function deriveAddresses(seedOrXpub,derivation,start,count){
    const bitcoin=window.bitcoinjs||window['bitcoinjs-lib'];
    const isXpub=looksLikeXpub(seedOrXpub);
    let root;
    if(isXpub){
      root=window.bip32.fromBase58(seedOrXpub.trim(),bitcoin.networks.bitcoin);
    }else{
      const seed=bip39.mnemonicToSeedSync(seedOrXpub.trim());
      root=window.bip32.fromSeed(seed,bitcoin.networks.bitcoin);
    }
    const purpose=derivation;
    const basePath=`m/${purpose}'/0'/0'/0`;
    const addrs=[];
    for(let i=start;i<start+count;i++){
      const path=isXpub?`m/${i}`:`${basePath}/${i}`;
      const child=root.derivePath(path);
      const pub=child.publicKey;
      let address;
      if(purpose==44) address=bitcoin.payments.p2pkh({pubkey:pub}).address;
      if(purpose==49) address=bitcoin.payments.p2sh({redeem:bitcoin.payments.p2wpkh({pubkey:pub})}).address;
      if(purpose==84) address=bitcoin.payments.p2wpkh({pubkey:pub}).address;
      if(purpose==86) address=bitcoin.payments.p2tr({internalPubkey:pub.slice(1,33)}).address;
      addrs.push({index:i,address});
    }
    return addrs;
  }

  scanBtn.addEventListener('click',async()=>{
    const inp=inputEl.value.trim();
    if(!inp){alert('Bitte Eingabe machen.');return;}
    const deriv=derivSelect.value;
    const start=parseInt(document.getElementById('startIdx').value);
    const count=parseInt(document.getElementById('count').value);
    resultEl.innerHTML=''; progressEl.textContent=''; txListEl.innerHTML='';

    try{
      let addresses=[];
      if(looksLikeAddress(inp)){
        addresses=[{index:0,address:inp}];
      }else{
        progressEl.textContent='Adressen werden abgeleitet...';
        addresses=await deriveAddresses(inp,deriv,start,count);
      }

      progressEl.textContent='Blockchain-Abfragen laufen...';
      let total=0;
      let html='<table><tr><th>#</th><th>Adresse</th><th>Empfangen</th><th>Ausgegeben</th><th>Unspent</th><th>TXs</th></tr>';
      let allTxs=[];

      for(let i=0;i<addresses.length;i++){
        const a=addresses[i];
        progressEl.textContent=`Frage ${i+1}/${addresses.length}: ${a.address}`;
        try{
          const js=await fetchBalance(a.address);
          const funded=js.chain_stats?.funded_txo_sum??0;
          const spent=js.chain_stats?.spent_txo_sum??0;
          const txc=js.chain_stats?.tx_count??0;
          const unspent=funded-spent;
          total+=unspent;

          const txs=await fetchTxs(a.address);
          txs.forEach(tx=>{
            allTxs.push({
              addr:a.address,
              id:tx.txid,
              conf:tx.status?.confirmed?tx.status.block_height:"unbestätigt",
              value:(tx.vout?.reduce((s,v)=>s+v.value,0)||0)/1e8
            });
          });

          html+=`<tr><td>${a.index}</td><td><code>${a.address}</code></td><td>${satsToBtc(funded)}</td><td>${satsToBtc(spent)}</td><td>${satsToBtc(unspent)}</td><td>${txc}</td></tr>`;
          await new Promise(r=>setTimeout(r,200));
        }catch(e){
          html+=`<tr><td>${a.index}</td><td colspan="5" class="bad">Fehler bei ${a.address}</td></tr>`;
        }
      }

      html+=`</table><div style="margin-top:8px" class="ok">Gesamt: ${total.toLocaleString()} sats = ${satsToBtc(total)} BTC</div>`;
      resultEl.innerHTML=html;

      if(allTxs.length>0){
        let txHTML='<b>Verbundene Transaktionen:</b><table><tr><th>Adresse</th><th>TX-ID</th><th>Bestätigungen</th><th>Wert (BTC)</th></tr>';
        allTxs.forEach(t=>{
          txHTML+=`<tr><td><code>${t.addr}</code></td><td>${t.id}</td><td>${t.conf}</td><td>${t.value.toFixed(8)}</td></tr>`;
        });
        txHTML+='</table>';
        txListEl.innerHTML=txHTML;
      }

      lastCheckedEl.textContent='Letzte Abfrage: '+new Date().toLocaleString();
      progressEl.textContent='Fertig.';
    }catch(e){
      console.error(e);
      progressEl.textContent='Fehler: '+e.message;
    }
  });
})();
</script>
</body>
</html>
